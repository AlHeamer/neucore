name: Build

on: [push]

jobs:
  test:
    name: Build
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        php-versions: ['7.3', '7.4', '8.0']
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: gmp, xdebug, apcu
          ini-values: apc.enable_cli=1
          tools: composer:v2
      - name: Install
        run: cd backend && composer install
      - name: Test with code coverage
        env:
          NEUCORE_APP_ENV: dev
          NEUCORE_TEST_DATABASE_URL: 'sqlite:///:memory:'
        run: cd backend && vendor/bin/phpunit --coverage-clover var/logs/clover.xml
      - name: Setup SonarQube
        if: ${{ github.repository_owner == 'tkhamez' && matrix.php-versions == '7.4' }}
        uses: warchant/setup-sonar-scanner@v3
      - name: SonarQube
        if: ${{ github.repository_owner == 'tkhamez' && matrix.php-versions == '7.4' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: sonar-scanner
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
          -Dsonar.organization=tkhamez-github
          -Dsonar.host.url=https://sonarcloud.io/
