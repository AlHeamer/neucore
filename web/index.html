<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Brave Collective Core Services Prototype</title>
    <script src="/node_modules/vue/dist/vue.js"></script>
    <script src="/node_modules/vue-resource/dist/vue-resource.js"></script>
</head>
<body>
    <div id="app">
        <button v-on:click="getUser">1. GET user info</button>
        <button v-on:click="getLogin">2. GET sso login url, you can provide a redirect url</button>
        <button v-on:click="redirect">3. redirect to sso login url</button>
        <button v-on:click="getUser"> 1. </button>
        &nbsp;
        <button v-on:click="logout">4. logout</button>

        <br>
        status:<br>
        <pre>{{ status }} {{ statusText }}</pre>

        body:<br>
        <pre>{{ body }}</pre>

        headers:<br>
        <pre>{{ headers }}</pre>
    </div>

    <script>

    // Only needed if frontend and backend are on different hosts.
    // Backend must allow the other host (config/settings.php [CORS][allow_origin]).
    var appBaseUrl = ''; // https://backend.domain.tld
    var clientBaseUrl = ''; // https://frontend.domain.tld

    var app = new Vue({
        el: '#app',
        data: {
            status: null,
            statusText: null,
            headers: null,
            body: null,
            oauthUrl: null
        },
        mounted: function () {
            if (location.hash) {
                this.get(location.hash.substr(1));
            }
        },
        methods: {
            getUser: function() {
                this.get(appBaseUrl + '/api/user/info');
            },
            getLogin: function() {
                var redirectPath = clientBaseUrl + '/index.html#' + appBaseUrl + '/api/user/auth/result';
                var url = appBaseUrl + '/api/user/auth/login?redirect_url=' + encodeURIComponent(redirectPath);
                this.get(url, function(response) {
                    app.oauthUrl = response.body.oauth_url;
                });
            },
            redirect: function() {
                if (app.oauthUrl) {
                    top.location.href = app.oauthUrl;
                }
            },
            logout: function() {
                this.get(appBaseUrl + '/api/user/auth/logout');
            },
            get: function(url, callback) {
                // "withCredentials" is only needed if frontend and backend are on different hosts.
                // Also make sure to send a "Accept: application/json" header to get errors in json format
                // (vue-resource does that by default).
                this.$http.get(url, { withCredentials: true }).then(response => {
                    handleResult(response);
                }, response => {
                    handleResult(response);
                });
                var handleResult = function(response) {
                    app.status = response.status;
                    app.statusText = response.statusText;
                    app.headers = response.headers;
                    app.body = response.body || response.bodyText;
                    if (callback) {
                        callback(response);
                    }
                }
            }
        }
    });
    </script>
</body>
</html>
